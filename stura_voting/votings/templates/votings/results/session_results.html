{% extends 'votings/base.html' %}

{% comment %}
Copyright 2018 - 2019 Fabian Wenzelmann

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
{% endcomment %}

{% load bootstrap4 %}
{% load hash %}
{% load currency %}
{% load lindex %}

{% block content %}
    <h2>Abstimmungsergebnisse für {{ collection.name }}</h2>
    {% if warnings %}
      <div class="alert alert-danger" role="alert">
        <h4><i class="fas fa-radiation-alt"></i> Warnung</h4>
        Das Auswerten der bisherigen Eintragungen hat zu Warnungen geführt.
        Bitte lies die folgenden Warnungen genaustens durch!
        Die aktuellen Daten sollten auf keinen Fall für eine Auszählung benutzt
        werden!
        <ul>
          {% for warning in warnings %}
            <li>{{ warning }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% for group, group_entries in groups %}
      <h3>{{ group.name }}</h3>
      {% for v_type, v, votes in group_entries %}
        {% if v_type == "median" %}

          {% with v_id=v.id m_result=median_results|hash:v.id median_inst=median_instances|hash:v.id %}
            <p>
              <h4>Finanzantrag {{ v.name }}</h4>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <td>Beantragt</td>
                    <td>Abgestimmt</td>
                    <td>Stimmen gesamt (Σ)</td>
                    <td>Quorum
                      {% if v.majority == "50" %}
                        (50% der Stimmen)
                      {% elif v.majority == "2/3" %}
                        ( <sup>2</sup>&frasl;<sub>3</sub> der Stimmen)
                      {% else %}
                        Unbekanntes Quorum
                      {% endif %}
                    </td>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{{ v.value|currency:v.currency }}</td>
                    <td>
                      {% if m_result is None %}
                        Kein Wert abgestimmt
                      {% else %}
                        {{ m_result|currency:v.currency }}
                      {% endif %}
                    </td>
                    <td>{{ median_inst.weight_sum }}</td>
                    <td>{{ median_inst.majority }}</td>
                  </tr>
                </tbody>
              </table>
            </p>
          {% endwith %}
        {% else %}
        <!-- schulze voting case -->
        {% comment %}
        Sorry for the ugly with line...
        {% endcomment %}
          {% with v_id=v.id s_result=schulze_results|hash:v.id schulze_inst=schulze_instances|hash:v.id options=schulze_votings.voting_description|hash:v.id num_no=schulze_num_no|hash:v.id percent_no=schulze_percent_no|hash:v.id %}
            <p>
              <h4>Abstimmung {{ v.name }}</h4>
              Bei einer
              {% if v.majority == "50" %}
                50% Mehrheit
              {% elif v.majority == "2/3" %}
                <sup>2</sup>&frasl;<sub>3</sub> Mehrheit
              {% else %}
                <b>Unbekanntes Quorum</b>
              {% endif %}
              von {{ schulze_inst.weight_sum }} Stimmen beträgt das Quorum
              {{ schulze_inst.majority }} Stimmen.
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <td>Gruppe</td>
                    <td>Option</td>
                    <td>Stimmen vor Nein</td>
                    <td>Prozent vor Nein</td>
                  </tr>
                </thead>
                <tbody>
                  {% for schulze_group in s_result.candidate_wins %}
                    {% with group_num=forloop.counter %}
                        {% comment %}
                        Only in first entry for this group: add <td> with rowspan
                        {% endcomment %}
                        {% for opt in schulze_group %}
                          <tr>
                            {% if forloop.counter == 1 %}
                              <td rowspan="{{ schulze_group|length }}" class="align-middle">{{ group_num }}</td>
                            {% endif %}

                            {% with option_desc=options|lindex:opt %}
                              <td>{{ option_desc.option }}</td>
                            {% endwith %}
                            <td>{{ num_no|lindex:opt }}</td>
                            <td>{{ percent_no|lindex:opt }}</td>
                          </tr>
                        {% endfor %}
                    {% endwith %}
                  {% endfor %}
                </tbody>
              </table>
            </p>
          {% endwith %}
          {% endif %}
      {% endfor %}
    {% endfor %}
{% endblock %}
